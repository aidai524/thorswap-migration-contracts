## `MetroTokenOFT` (`src/metro.sol`)

Purpose: OFT-compatible ERC20 token with ERC20 Permit support and an owner-managed minter allowlist.

### Owner / Admin
- `setMinter(address minter, bool status) external`
  - Grants or revokes permission for `minter` to call `mint(...)` (owner-only).

### Minting
- `mint(address to, uint256 amount) external`
  - Mints `amount` tokens to `to` if the caller is allowlisted.

Common autogenerated getter:
- `isMinter(address) -> bool`
  - Returns whether an address is allowlisted to mint.

---

## `xMETRO` (`src/xMETRO.sol`)

Purpose: Core staking + migration locking/vesting + reward distribution + optional autocompounding.

### User: free shares (stake / unstake)
- `stake(uint256 amount) external returns (uint256 mintedShares)`
  - Stakes `METRO` and mints free `xMETRO` shares 1:1 to the caller.

- `requestUnstake(uint256 amount) external`
  - Burns free shares and starts a cooldown before the caller can withdraw the underlying `METRO`.

- `withdraw(uint256 maxRequests) external returns (uint256 amountOut)`
  - Withdraws `METRO` for matured unstake requests (optionally capped by `maxRequests`).

### User: locked positions (principal withdrawals)
- `withdrawUnlockedThor(uint256 maxLocks) external returns (uint256 amountOut)`
  - Withdraws any currently-unlocked THOR-migration principal as `METRO`.

- `withdrawUnlockedYThor(uint256 maxSchedules) external returns (uint256 amountOut)`
  - Withdraws any currently-vested yTHOR-migration principal as `METRO`.

- `stakeContributor(uint256 amount) external`
  - Creates a contributor vesting position by staking `METRO` (only whitelisted contributors).

- `withdrawUnlockedContributor(uint256 maxSchedules) external returns (uint256 amountOut)`
  - Withdraws any currently-vested contributor principal as `METRO`.

### Rewards
- `depositRewards(uint256 amount) external`
  - Deposits `rewardToken` rewards into the pool and updates reward accounting (only `rewardDistributor`).

- `claimRewards() external returns (uint256 pending)`
  - Claims the caller's pending rewards in `rewardToken`.

### Autocompound (optional)
- `autocompound(uint256 minMetroOut, bytes calldata swapData) external returns (uint256 metroOut)`
  - Swaps the caller's pending rewards into `METRO` and mints the output as additional free shares.

- `enableAutocompound() external`
  - Opts the caller into batch autocompounding.

- `disableAutocompound() external`
  - Opts the caller out of batch autocompounding.

- `autocompoundBatch(address[] calldata users, uint256 minMetroOut, bytes calldata swapData) external returns (uint256 metroOut)`
  - Operator-only; compounds multiple users in one swap and mints output shares pro-rata to each user's pending rewards.

### Migration credit (escrow-only)
- `creditLockedTHORFromMigration(address user, uint256 amount, uint256 lockMonths) external`
  - Credits a locked THOR-migration position for `user` (only `migrationEscrow`).

- `creditLockedVestingFromMigration(address user, uint256 amount) external`
  - Credits a locked vesting schedule for `user` (only `migrationEscrow`).

### ERC20 overrides (reward accounting)
- `transfer(address to, uint256 amount) public returns (bool)`
  - Transfers free shares and adjusts reward accounting so rewards remain fair after transfers.

- `transferFrom(address from, address to, uint256 amount) public returns (bool)`
  - Same as `transfer`, but for allowance-based transfers.

### Owner / Admin
- `pause() external`
  - Pauses state-changing flows protected by `whenNotPaused` (owner-only).

- `unpause() external`
  - Unpauses the contract (owner-only).

- `setSwapAdapter(address swapAdapter_) external`
  - Sets the swap adapter used by autocompounding (owner-only); set to zero to disable swapping.

- `setMigrationEscrow(address escrow) external`
  - Sets the migration escrow allowed to call `creditLocked*FromMigration` (owner-only).

- `setRewardDistributor(address distributor) external`
  - Sets the distributor allowed to call `depositRewards` (owner-only).

- `setAutoCompoundOperator(address operator, bool allowed) external`
  - Grants/revokes permission to call `autocompoundBatch` (owner-only).

- `setDefaultMaxVestingSchedules(uint256 newDefault) external`
  - Sets a default per-call limit for scanning vesting schedules during withdrawals (owner-only).

- `setDefaultMaxThorLocks(uint256 newDefault) external`
  - Sets a default per-call limit for scanning THOR lock entries during withdrawals (owner-only).

- `setContributor(address contributor, bool allowed) external`
  - Whitelists/unwhitelists a contributor address for `stakeContributor` (owner-only).

- `rescueERC20(address token, address to, uint256 amount) external`
  - Rescues arbitrary ERC20 tokens held by `xMETRO` (owner-only).

### Views
- `totalShares() public view returns (uint256)`
  - Returns free shares plus locked shares (reward distribution baseline).

- `totalSharesOf(address user) public view returns (uint256)`
  - Returns the user's free shares plus locked shares.

- `claimable(address user) external view returns (uint256)`
  - Returns the user's pending rewards in `rewardToken`.

- `claimableMany(address[] calldata users) external view returns (uint256 totalPending, uint256[] memory pendings)`
  - Returns the total pending rewards and a per-user pending array aligned with `users`.

- `previewWithdrawableNow(address user) external view returns (uint256 thorUnlockable, uint256 yThorUnlockable, uint256 contributorUnlockable, uint256 totalUnlockable)`
  - Returns how much principal is currently withdrawable across all lock/vesting mechanisms.

- `yThorVestingCount(address user) external view returns (uint256)`
  - Returns the number of yTHOR vesting schedules for `user`.

- `yThorVesting(address user, uint256 index) external view returns (VestingSchedule memory)`
  - Returns the yTHOR vesting schedule at `index` for `user`.

- `thorLocks3mCount(address user) external view returns (uint256)`
  - Returns the number of 3-month THOR lock entries for `user`.

- `thorLocks10mCount(address user) external view returns (uint256)`
  - Returns the number of 10-month THOR lock entries for `user`.

- `thorLock3m(address user, uint256 index) external view returns (ThorLock memory)`
  - Returns the 3-month THOR lock entry at `index` for `user`.

- `thorLock10m(address user, uint256 index) external view returns (ThorLock memory)`
  - Returns the 10-month THOR lock entry at `index` for `user`.

- `unstakeRequestCount(address user) external view returns (uint256)`
  - Returns the number of unstake requests for `user`.

- `unstakeRequest(address user, uint256 index) external view returns (UnstakeRequest memory)`
  - Returns the unstake request at `index` for `user`.

- `contributorVestingCount(address user) external view returns (uint256)`
  - Returns the number of contributor vesting schedules for `user`.

- `contributorVesting(address user, uint256 index) external view returns (VestingSchedule memory)`
  - Returns the contributor vesting schedule at `index` for `user`.

---

## `SwapAdapter` (`src/SwapAdapter.sol`)

Purpose: Swaps the reward token (USDC) into `METRO` via Uniswap V2 or V3 for use by `xMETRO`.

### Swap entrypoint
- `swap(uint256 amountIn, uint256 minAmountOut, bytes calldata swapData) external returns (uint256 amountOut)`
  - Swaps `amountIn` USDC into `METRO` and delivers output to `xMETRO` (callable only by `xMETRO`).

### Owner / Admin
- `pause() external`
  - Pauses swaps (owner-only).

- `unpause() external`
  - Unpauses swaps (owner-only).

- `rescueTokens(address token, address to, uint256 amount) external`
  - Rescues tokens accidentally held by the adapter (owner-only).

---

## `RewardDistributor` (`src/RewardDistributor.sol`)

Purpose: Operator-gated reward forwarding into `xMETRO.depositRewards(...)`.

### Owner / Admin
- `setOperator(address operator, bool allowed) external`
  - Grants/revokes permission to distribute rewards (owner-only).

- `rescueTokens(address token, address to, uint256 amount) external`
  - Rescues tokens accidentally held by the distributor (owner-only).

### Operator functions
- `distribute(uint256 amount) external`
  - Pulls `rewardToken` from the operator and deposits it into `xMETRO` as rewards (operator-only).

- `distributeFromBalance(uint256 amount) external`
  - Deposits rewards using this contract's existing `rewardToken` balance (operator-only).

---

## `ThorMigrationEscrow` (`src/ThorMigrationEscrow.sol`)

Purpose: Custodies THOR/yTHOR and creates locked/vesting positions in `xMETRO` under caps, ratios, and deadlines.

### User migrations
- `migrateThor10m(uint256 amountIn) external`
  - Migrates THOR using the 10-month bucket (if not expired and cap allows).

- `migrateThor3m(uint256 amountIn) external`
  - Migrates THOR using the 3-month bucket (only when the 10-month bucket is not available for this amount).

- `migrateYThor(uint256 amountIn) external`
  - Migrates yTHOR into a vesting schedule in `xMETRO` (if not expired and cap allows).

### Owner configuration
- `setMigrationStartTime(uint256 newStartTime) external`
  - Updates the migration start time (owner-only).

- `setDeadlines(uint256 newDeadline10M, uint256 newDeadline3M) external`
  - Updates bucket deadlines for THOR migration (owner-only).

- `setRatios(uint256 newRatio10M, uint256 newRatio3M, uint256 newRatioYThor) external`
  - Updates conversion ratios (1e18-scaled, owner-only).

- `setCaps(uint256 newCap10M, uint256 newCap3M) external`
  - Updates mint caps for THOR buckets (denominated in minted `METRO`, owner-only).

- `setYThorLimits(uint256 newCapYThor, uint256 newDeadlineYThor) external`
  - Updates cap and deadline for the yTHOR bucket (owner-only).

### Owner / Admin
- `pause() external`
  - Pauses migration entrypoints (owner-only).

- `unpause() external`
  - Unpauses migration entrypoints (owner-only).

- `rescueTokens(address token, address to, uint256 amount) external`
  - Rescues arbitrary tokens held by the escrow (excluding THOR and yTHOR, owner-only).